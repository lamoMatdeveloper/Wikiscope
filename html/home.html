<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="../Documentos/Imágenes/WikiScope_logo.png" type="image/png">
  <title>WikiScope — Panel personal</title>
  <style>
    :root{
      --bg:#f6f7f9; --sidebar:#ffffff; --border:#e5e7eb; --shadow:0 10px 30px rgba(15,23,42,.06);
      --text:#1f2937; --muted:#6b7280; --accent:#2563eb; --accent-soft:#eef2ff; --card:#ffffff;
      --radius:18px; --radius-sm:12px; --success:#10b981; --warning:#f59e0b; --error:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex}
    .app{display:grid;grid-template-columns:260px 1fr;width:100%;min-height:100vh}
    aside{background:var(--sidebar);padding:28px 22px;border-right:1px solid var(--border);display:flex;flex-direction:column;gap:24px}
    .brand{display:flex;align-items:center;gap:12px;font-size:24px;font-weight:700;letter-spacing:-.01em}
    .brand img{width:42px;height:42px}
    nav{display:flex;flex-direction:column;gap:10px}
    nav a{padding:12px 14px;border-radius:var(--radius-sm);color:var(--muted);text-decoration:none;font-weight:600;display:flex;align-items:center;gap:10px}
    nav a.active{background:var(--accent-soft);color:var(--accent)}
    nav a:hover{background:#f3f4f6;color:var(--text)}
    .nav-footer{margin-top:auto;display:grid;gap:12px}
    .btn-ghost{border:1px solid var(--border);background:#fff;border-radius:var(--radius-sm);padding:10px 14px;font-weight:600;cursor:pointer;display:inline-flex;justify-content:center;align-items:center;gap:8px}
    .btn-ghost:hover{border-color:var(--accent);color:var(--accent)}
    .btn-icon{background:none;border:none;padding:8px;cursor:pointer;color:var(--muted);border-radius:var(--radius-sm)}
    .btn-icon:hover{background:var(--accent-soft);color:var(--accent)}

    main{padding:32px 36px 48px;display:flex;flex-direction:column;gap:24px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:20px}
    .search{flex:1;display:flex;align-items:center;gap:12px;background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:12px 16px;box-shadow:var(--shadow)}
    .search input{border:0;outline:none;width:100%;font-size:16px;color:var(--text)}
    .search button{background:var(--accent);color:#fff;border:0;border-radius:var(--radius-sm);padding:10px 18px;font-weight:600;cursor:pointer}
    .search button:disabled{opacity:.6;cursor:not-allowed}
    .persona-chip{display:flex;flex-direction:column;min-width:210px;background:#fff;border-radius:var(--radius);padding:14px 18px;border:1px solid var(--border);box-shadow:var(--shadow)}
    .persona-chip span{color:var(--muted);font-size:13px;text-transform:uppercase;letter-spacing:.08em}
    .persona-chip strong{font-size:16px;font-weight:700;margin-top:6px}

    /* Chat styles */
    .chat-container{display:flex;flex-direction:column;height:calc(100vh - 120px);max-height:800px;background:var(--card);border-radius:var(--radius);border:1px solid var(--border);box-shadow:var(--shadow)}
    .chat-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .chat-header h2{margin:0;font-size:24px;font-weight:700;letter-spacing:-.01em}
    .mode-controls{display:flex;align-items:center;gap:12px}
    .segmented{display:flex;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .segmented button{border:0;padding:8px 12px;background:#fff;cursor:pointer}
    .segmented button.active{background:var(--accent);color:#fff}
    .temp-wrap{display:flex;align-items:center;gap:8px}
    .temp-wrap input[type="range"]{width:160px}
    .sel{height:34px;border:1px solid var(--border);border-radius:10px;padding:4px 8px;background:#fff}
    .chat-messages{flex:1;padding:20px 24px;overflow-y:auto;display:flex;flex-direction:column;gap:16px}
    .message{max-width:80%;padding:12px 16px;border-radius:18px}
    .message.user{align-self:flex-end;background:var(--accent);color:#fff}
    .message.assistant{align-self:flex-start;background:#f1f5f9;border:1px solid var(--border)}
    .message.system{align-self:center;background:#fef3c7;border:1px solid var(--warning);color:#92400e;font-size:14px;padding:8px 12px}
    .message-typing{display:flex;align-items:center;gap:8px}
    .typing-indicator{display:flex;gap:4px}
    .typing-dot{width:8px;height:8px;background:var(--muted);border-radius:50%;animation:typing 1.4s infinite ease-in-out}
    .typing-dot:nth-child(1){animation-delay:0s}
    .typing-dot:nth-child(2){animation-delay:0.2s}
    .typing-dot:nth-child(3){animation-delay:0.4s}
    @keyframes typing{
      0%,60%,100%{transform:translateY(0)}
      30%{transform:translateY(-5px)}
    }
    .chat-input-container{padding:20px 24px;border-top:1px solid var(--border);display:flex;gap:12px}
    .chat-input{flex:1;padding:12px 16px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:15px;resize:none;min-height:56px;max-height:120px}
    .chat-input:focus{outline:none;border-color:var(--accent)}
    .chat-send-btn{background:var(--accent);color:#fff;border:0;border-radius:var(--radius-sm);padding:0 20px;font-weight:600;cursor:pointer;align-self:flex-end}
    .chat-send-btn:disabled{opacity:.6;cursor:not-allowed}

    /* Quick actions */
    .quick-actions{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:24px}
    .quick-action-card{background:var(--card);border-radius:var(--radius);padding:20px;border:1px solid var(--border);box-shadow:var(--shadow);cursor:pointer;transition:all .2s}
    .quick-action-card:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(0,0,0,.1)}
    .quick-action-card h3{margin:0 0 8px;font-size:18px;font-weight:600}
    .quick-action-card p{margin:0;color:var(--muted);font-size:14px}

    /* Collections */
    .collections-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px;margin-top:24px}
    .collection-card{background:var(--card);border-radius:var(--radius);padding:20px;border:1px solid var(--border);box-shadow:var(--shadow);cursor:pointer}
    .collection-card:hover{border-color:var(--accent)}
    .collection-card h3{margin:0 0 8px;font-size:18px;font-weight:600}
    .collection-card p{margin:0;color:var(--muted);font-size:14px}

    /* Explore topics */
    .topics-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin-top:24px}
    .topic-card{background:var(--card);border-radius:var(--radius);padding:16px;border:1px solid var(--border);box-shadow:var(--shadow);cursor:pointer;text-align:center}
    .topic-card:hover{border-color:var(--accent)}
    .topic-card h3{margin:0;font-size:16px;font-weight:600}
    .topic-card p{margin:8px 0 0;color:var(--muted);font-size:13px}

    footer{margin-top:12px;font-size:13px;color:var(--muted);display:flex;justify-content:space-between;flex-wrap:wrap;gap:8px}
    footer a{color:var(--muted);text-decoration:none}
    footer a:hover{text-decoration:underline}

    @media(max-width:1080px){
      .app{grid-template-columns:1fr}
      aside{display:none}
      main{padding:24px}
    }
    @media(max-width:640px){
      .search{flex-direction:column;align-items:stretch}
      .search button{width:100%}
      .chat-messages{padding:16px}
      .message{max-width:90%}
      .quick-actions{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <aside>
      <div class="brand">
        <img src="../Documentos/Imágenes/WikiScope_logo.png" alt="Logo de WikiScope" />
        <span>WikiScope</span>
      </div>
      <nav>
        <a class="active" href="#inicio">Inicio</a>
        <a href="#colecciones">Colecciones</a>
        <a href="#explorar">Explorar temas</a>
        <a href="#ajustes">Ajustes</a>
      </nav>
      <div class="nav-footer">
        <button id="btn-sync" class="btn-ghost" type="button">Sincronizar con servidor</button>
        <button id="btn-logout" class="btn-ghost" type="button">Cerrar sesión</button>
      </div>
    </aside>

    <main>
      <header class="topbar">
        <form id="search-form" class="search" autocomplete="off">
          <input id="search-query" type="search" placeholder="Busca cualquier tema para investigar..." />
          <button id="search-btn" type="submit">Analizar</button>
        </form>
        <div class="persona-chip">
          <span>Perfil activo</span>
          <strong id="persona-summary">Cargando preferencias…</strong>
        </div>
      </header>

      <!-- Vista principal: Chat -->
      <div id="view-inicio" class="view active">
        <article class="card" id="analysis-card" style="display:none; margin-bottom:16px">
          <div class="card-header">
            <h2>Análisis rápido de Wikipedia</h2>
            <span id="analysis-status" class="muted"></span>
          </div>
          <div id="analysis-content" class="muted">Introduce un tema en la búsqueda para generar un análisis.</div>
        </article>
        <div class="chat-container">
          <div class="chat-header">
            <h2>Agente investigador</h2>
            <div class="mode-controls">
              <div class="segmented" role="tablist" aria-label="Modo">
                <button id="mode-research" class="active" role="tab" aria-selected="true">Investigación</button>
                <button id="mode-conv" role="tab" aria-selected="false">Conversacional</button>
              </div>
              <div class="temp-wrap" title="Creatividad del modelo">
                <span class="muted">Creatividad</span>
                <input id="temp" type="range" min="0" max="1" step="0.05" value="0.20" />
                <span id="temp-value" class="muted">0.20</span>
              </div>
              <select id="provider-select" class="sel" title="Proveedor de IA"></select>
              <select id="model-select" class="sel" title="Modelo"></select>
            </div>
            <span class="muted" id="chat-status">Listo para investigar</span>
          </div>
          <div id="chat-messages" class="chat-messages">
            <div class="message assistant">
              <div class="content">¡Hola! Soy tu asistente de investigación de WikiScope. ¿Sobre qué tema te gustaría investigar hoy?</div>
            </div>
          </div>
          <div class="chat-input-container">
            <textarea id="chat-input" class="chat-input" placeholder="Escribe tu pregunta aquí..."></textarea>
            <button id="chat-send" class="chat-send-btn">Enviar</button>
          </div>
        </div>

        <!-- Acciones rápidas -->
        <div class="quick-actions">
          <div class="quick-action-card" onclick="showView('colecciones')">
            <h3>Colecciones</h3>
            <p>Explora tus colecciones guardadas</p>
          </div>
          <div class="quick-action-card" onclick="showView('explorar')">
            <h3>Explorar temas</h3>
            <p>Descubre nuevos temas de interés</p>
          </div>
          <div class="quick-action-card" onclick="showView('ajustes')">
            <h3>Ajustes</h3>
            <p>Personaliza tu experiencia</p>
          </div>
        </div>
      </div>

      <!-- Vista de Colecciones -->
      <div id="view-colecciones" class="view" style="display:none">
        <h2>Colecciones</h2>
        <div class="collections-grid">
          <div class="collection-card">
            <h3>Ciencia e Innovación</h3>
            <p>12 artículos guardados</p>
          </div>
          <div class="collection-card">
            <h3>Historia Moderna</h3>
            <p>8 artículos guardados</p>
          </div>
          <div class="collection-card">
            <h3>Biografías Destacadas</h3>
            <p>15 artículos guardados</p>
          </div>
        </div>
      </div>

      <!-- Vista de Explorar temas -->
      <div id="view-explorar" class="view" style="display:none">
        <h2>Explorar temas</h2>
        <div class="topics-grid">
          <div class="topic-card">
            <h3>Inteligencia Artificial</h3>
            <p>Tecnología</p>
          </div>
          <div class="topic-card">
            <h3>Cambio Climático</h3>
            <p>Medio Ambiente</p>
          </div>
          <div class="topic-card">
            <h3>Neurociencia</h3>
            <p>Ciencia</p>
          </div>
          <div class="topic-card">
            <h3>Economía Digital</h3>
            <p>Finanzas</p>
          </div>
        </div>
      </div>

      <!-- Vista de Ajustes -->
      <div id="view-ajustes" class="view" style="display:none">
        <h2>Ajustes</h2>
        <article class="card">
          <div class="card-header">
            <h2>Personaliza tu experiencia</h2>
            <span class="muted">Se guarda al instante</span>
          </div>
          <form id="persona-form" class="persona-form" autocomplete="off">
            <div class="persona-fields">
              <label for="pref-name">Nombre de usuario</label>
              <input id="pref-name" type="text" placeholder="Ej. Ana Investigadora" />
            </div>
            <div class="persona-fields">
              <label for="pref-lang">Idioma preferido</label>
              <select id="pref-lang">
                <option value="es">Español</option>
                <option value="en">English</option>
              </select>
            </div>
            <div class="persona-fields">
              <label for="pref-level">Profundidad deseada</label>
              <select id="pref-level">
                <option value="intro">Introductorio</option>
                <option value="advanced">Avanzado</option>
              </select>
            </div>
            <div class="persona-fields">
              <label for="pref-format">Formato de resumen</label>
              <select id="pref-format">
                <option value="tldr">TL;DR citado</option>
                <option value="narrative">Narrativa continua</option>
              </select>
            </div>
            <div class="persona-fields">
              <label>Enfoques prioritarios</label>
              <div class="chip-list" id="pref-focus">
                <button type="button" class="chip" data-value="apps">Aplicaciones</button>
                <button type="button" class="chip" data-value="data">Datos</button>
                <button type="button" class="chip" data-value="bio">Biografías</button>
                <button type="button" class="chip" data-value="history">Historia</button>
              </div>
            </div>
            <div class="persona-fields">
              <label>Tono preferido</label>
              <div class="chip-list" id="pref-tone">
                <button type="button" class="chip" data-value="neutro">Neutro</button>
                <button type="button" class="chip" data-value="didáctico">Didáctico</button>
                <button type="button" class="chip" data-value="entusiasta">Entusiasta</button>
                <button type="button" class="chip" data-value="crítico">Crítico</button>
              </div>
            </div>
            <div class="persona-fields">
              <label for="pref-length">Extensión de la respuesta: <span id="pref-length-value" class="muted">media</span></label>
              <input id="pref-length" type="range" min="1" max="5" step="1" value="3" />
            </div>
            <div class="persona-fields">
              <label>Estructura deseada</label>
              <div class="chip-list" id="pref-structure">
                <button type="button" class="chip" data-value="bullets">Bullets</button>
                <button type="button" class="chip" data-value="narrativa">Narrativa</button>
                <button type="button" class="chip" data-value="timeline">Línea de tiempo</button>
                <button type="button" class="chip" data-value="evidencia">Tabla de evidencia</button>
              </div>
            </div>
            <div class="persona-fields">
              <label for="pref-citelevel">Rigor de citas: <span id="pref-citelevel-value" class="muted">alto</span></label>
              <input id="pref-citelevel" type="range" min="0" max="1" step="0.05" value="0.7" />
            </div>
            <div class="persona-fields">
              <label for="pref-notes">Instrucciones personalizadas</label>
              <textarea id="pref-notes" style="min-height:90px" placeholder="Ej. Prefiero ejemplos con aplicaciones reales y comparaciones simples..."></textarea>
            </div>
          </form>
          <div class="actions">
            <button id="btn-reset" class="btn-ghost" type="button">Revertir cambios</button>
            <button id="btn-save" class="btn-primary" type="button">Guardar preferencias</button>
          </div>
        </article>
      </div>

      <footer>
        <span>Contenido generado bajo CC BY-SA 4.0 con atribución a Wikipedia cuando corresponda.</span>
        <span>
          <a href="https://www.wikipedia.org" target="_blank" rel="noopener">Wikipedia</a> ·
          <a href="#historial">Historial de ediciones</a>
        </span>
      </footer>
    </main>
  </div>

  <script src="scripts/wikipedia.js"></script>
  <script>
    const STORAGE_KEY = 'wikiscope:prefs';
    const SYSTEM_PROMPT_PATH = '../Documentos/contexto/research_agent_prompt.md';
    // Usar solamente el vault del frontend
    const VAULT_PATH = 'vault.ink';

    const state = {
      prefs: {
        username: '',
        lang: 'es',
        level: 'intro',
        format: 'tldr',
        focus: ['apps'],
        show_cites: true,
        mode: 'research',
        temp: 0.2,
        tone: ['neutro'],
        length: 3,
        structure: ['bullets'],
        cite_level: 0.7,
        notes: '',
        provider: 'deepseek',
        model: 'deepseek-chat'
      },
      config: null,
      systemPrompt: '',
      conversation: []
    };

    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>Array.from(document.querySelectorAll(sel));

    // Función para cambiar entre vistas
    function showView(viewId) {
      // Ocultar todas las vistas
      $$('.view').forEach(view => {
        view.style.display = 'none';
      });
      
      // Mostrar la vista seleccionada
      $('#view-' + viewId).style.display = 'block';
      
      // Actualizar navegación activa
      $$('nav a').forEach(link => {
        link.classList.remove('active');
      });
      
      // Encontrar y activar el enlace correspondiente
      const activeLink = Array.from($$('nav a')).find(link => 
        link.getAttribute('href') === '#' + viewId
      );
      if (activeLink) {
        activeLink.classList.add('active');
      }
    }

    init();

    async function init(){
      try{
        state.config = await loadVault();
      }catch(err){
        console.warn('No se pudo cargar vault.ink', err);
      }
      try{
        state.systemPrompt = await fetchText(SYSTEM_PROMPT_PATH);
      }catch(err){
        console.warn('No se pudo cargar el prompt', err);
      }
      const stored = loadPrefs();
      state.prefs = Object.assign({}, state.prefs, stored);
      if(!stored){
        window.location.href = 'loggin.html';
        return;
      }
      renderPrefs();
      // inicializar controles de modo/temperatura
      updateModeUI();
      initProviderModelSelectors();
      bindEvents();
      updatePersonaSummary();
    }

    async function loadVault(){
      const res = await fetch(VAULT_PATH, { cache: 'no-store' });
      if(!res.ok) return {};
      const txt = (await res.text()).trim();
      if(!txt) return {};
      try{
        const cfg = JSON.parse(txt);
        return cfg || {};
      }catch(_){ return {}; }
    }

    function initProviderModelSelectors(){
      const providerSel = $('#provider-select');
      const modelSel = $('#model-select');
      const providers = [];
      if(state.config?.deepseek) providers.push('deepseek');
      if(state.config?.openai) providers.push('openai');
      if(providers.length===0) providers.push('deepseek');
      providerSel.innerHTML = providers.map(p=> `<option value="${p}">${p}</option>`).join('');
      // aplicar preferencia guardada
      if(state.prefs.provider && providers.includes(state.prefs.provider)) providerSel.value = state.prefs.provider;
      refreshModelOptions();
      providerSel.addEventListener('change', ()=>{
        state.prefs.provider = providerSel.value;
        refreshModelOptions();
        persistPrefs();
      });
      modelSel.addEventListener('change', ()=>{
        state.prefs.model = modelSel.value;
        persistPrefs();
      });
    }

    function refreshModelOptions(){
      const provider = state.prefs.provider || 'deepseek';
      const modelSel = $('#model-select');
      let models = [];
      if(provider==='deepseek'){
        const cfg = state.config?.deepseek || {};
        models = cfg.models || [cfg.model || 'deepseek-chat', 'deepseek-coder'];
      }else if(provider==='openai'){
        const cfg = state.config?.openai || {};
        models = cfg.models || [cfg.model || 'chatgpt-5-nano', 'gpt-4o-mini'];
      }
      models = [...new Set(models.filter(Boolean))];
      modelSel.innerHTML = models.map(m=> `<option value="${m}">${m}</option>`).join('');
      state.prefs.model = state.prefs.model && models.includes(state.prefs.model) ? state.prefs.model : models[0];
      modelSel.value = state.prefs.model;
    }

    async function fetchText(path){
      const res = await fetch(path, { cache: 'no-store' });
      if(!res.ok) throw new Error('No se pudo cargar ' + path);
      return await res.text();
    }

    function loadPrefs(){
      try{
        const saved = localStorage.getItem(STORAGE_KEY);
        return saved ? JSON.parse(saved) : null;
      }catch(_){ return null; }
    }

    function renderPrefs(){
      $('#pref-name').value = state.prefs?.username || '';
      $('#pref-lang').value = state.prefs?.lang || 'es';
      $('#pref-level').value = state.prefs?.level || 'intro';
      $('#pref-format').value = state.prefs?.format || 'tldr';
      // compatibilidad con pref_cites heredado
      $('#pref-cites')?.setAttribute('aria-hidden','true');
      const focusSet = new Set(state.prefs?.focus || []);
      $$('#pref-focus .chip').forEach(ch=>{
        ch.setAttribute('aria-pressed', focusSet.has(ch.dataset.value) ? 'true' : 'false');
      });
      // Controles de modo/temperatura
      const t = typeof state.prefs?.temp === 'number' ? state.prefs.temp : 0.2;
      const tempEl = $('#temp'); const lbl = $('#temp-value');
      if (tempEl && lbl) { tempEl.value = t.toFixed(2); lbl.textContent = Number(tempEl.value).toFixed(2); }
      // Tono, longitud, estructura, citas, notas
      const toneSet = new Set(state.prefs?.tone || []);
      $$('#pref-tone .chip').forEach(ch=> ch.setAttribute('aria-pressed', toneSet.has(ch.dataset.value) ? 'true' : 'false'));
      $('#pref-length').value = String(state.prefs?.length ?? 3);
      { const labels=['muy corta','corta','media','larga','muy larga']; const lv=Number($('#pref-length').value)||3; $('#pref-length-value').textContent = labels[(lv-1)|0]; }
      const structSet = new Set(state.prefs?.structure || []);
      $$('#pref-structure .chip').forEach(ch=> ch.setAttribute('aria-pressed', structSet.has(ch.dataset.value) ? 'true' : 'false'));
      $('#pref-citelevel').value = (state.prefs?.cite_level ?? 0.7);
      $('#pref-citelevel-value').textContent = (state.prefs?.cite_level ?? 0.7) >= 0.7 ? 'alto' : (state.prefs?.cite_level ?? 0.7) >= 0.4 ? 'medio' : 'bajo';
      $('#pref-notes').value = state.prefs?.notes || '';
    }

    function bindEvents(){
      $('#btn-save').addEventListener('click', savePrefs);
      $('#btn-reset').addEventListener('click', ()=>{
        state.prefs = loadPrefs() || state.prefs;
        renderPrefs();
        updatePersonaSummary();
      });
      $('#persona-form').addEventListener('change', handleFormChange);
      $('#pref-name').addEventListener('input', handleFormChange);
      $$('#pref-focus .chip').forEach(ch=>{
        ch.addEventListener('click', ()=>{
          const pressed = ch.getAttribute('aria-pressed') === 'true';
          ch.setAttribute('aria-pressed', String(!pressed));
          handleFormChange();
        });
      });
      $$('#pref-tone .chip').forEach(ch=>{
        ch.addEventListener('click', ()=>{
          const pressed = ch.getAttribute('aria-pressed') === 'true';
          ch.setAttribute('aria-pressed', String(!pressed));
          handleFormChange();
        });
      });
      $$('#pref-structure .chip').forEach(ch=>{
        ch.addEventListener('click', ()=>{
          const pressed = ch.getAttribute('aria-pressed') === 'true';
          ch.setAttribute('aria-pressed', String(!pressed));
          handleFormChange();
        });
      });
      $('#pref-length').addEventListener('input', ()=>{
        const labels=['muy corta','corta','media','larga','muy larga'];
        const lv=Number($('#pref-length').value)||3;
        $('#pref-length-value').textContent = labels[(lv-1)|0];
        handleFormChange();
      });
      $('#pref-citelevel').addEventListener('input', ()=>{
        const v = Number($('#pref-citelevel').value);
        $('#pref-citelevel-value').textContent = v>=0.7?'alto':v>=0.4?'medio':'bajo';
        handleFormChange();
      });
      $('#pref-notes').addEventListener('input', handleFormChange);
      $('#btn-logout').addEventListener('click', ()=>{
        localStorage.removeItem(STORAGE_KEY);
        window.location.href = 'loggin.html';
      });
      $('#btn-sync').addEventListener('click', ()=>{
        alert('Sincronización con backend pendiente de implementación.');
      });

      // Eventos del chat
      $('#chat-form')?.addEventListener('submit', async (event)=>{
        event.preventDefault();
        await handleChatSubmit();
      });
      
      $('#chat-send').addEventListener('click', async () => {
        await handleChatSubmit();
      });
      
      $('#chat-input').addEventListener('keydown', async (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          await handleChatSubmit();
        }
      });
      
      // Eventos de navegación
      $$('nav a').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const href = link.getAttribute('href');
          if (href.startsWith('#')) {
            const viewId = href.substring(1);
            showView(viewId);
          }
        });
      });

      // Modo y temperatura
      $('#mode-research').addEventListener('click', ()=> setMode('research'));
      $('#mode-conv').addEventListener('click', ()=> setMode('conversational'));
      $('#temp').addEventListener('input', (e)=>{
        const v = Number(e.target.value);
        state.prefs.temp = Math.min(1, Math.max(0, v));
        $('#temp-value').textContent = v.toFixed(2);
        persistPrefs();
      });

      // Búsqueda / análisis de Wikipedia
      $('#search-form').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const q = $('#search-query').value.trim();
        if(!q) return;
        await runAnalysis(q);
      });
    }

    async function handleChatSubmit() {
      const input = $('#chat-input');
      const text = input.value.trim();
      if(!text) return;
      
      // Añadir mensaje del usuario y a la conversación
      appendUserMessage(text);
      state.conversation.push({ role:'user', content:text, createdAt:Date.now() });
      input.value = '';
      
      // Mostrar indicador de escritura
      showTypingIndicator();
      
      // Llamar al agente real (proxy DeepSeek)
      try{
        await sendToAgent(text);
      } finally {
        hideTypingIndicator();
      }
    }

    function handleFormChange(){
      const focus = $$('#pref-focus .chip[aria-pressed="true"]').map(b=>b.dataset.value);
      const tone = $$('#pref-tone .chip[aria-pressed="true"]').map(b=>b.dataset.value);
      const structure = $$('#pref-structure .chip[aria-pressed="true"]').map(b=>b.dataset.value);
      state.prefs = {
        username: $('#pref-name').value.trim(),
        lang: $('#pref-lang').value,
        level: $('#pref-level').value,
        format: $('#pref-format').value,
        focus,
        tone,
        length: Number($('#pref-length').value),
        structure,
        cite_level: Number($('#pref-citelevel').value),
        notes: $('#pref-notes').value.trim(),
        show_cites: true
      };
      updatePersonaSummary();
    }

    function savePrefs(){
      persistPrefs();
      updatePersonaSummary('Preferencias guardadas');
    }

    function persistPrefs(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state.prefs));
    }

    function updatePersonaSummary(status){
      const focus = state.prefs.focus?.length ? state.prefs.focus.join(', ') : 'sin enfoque específico';
      const label = `${state.prefs.username || 'Investigador/a'} · ${state.prefs.lang === 'en' ? 'Inglés' : 'Español'} · ${state.prefs.level === 'advanced' ? 'Avanzado' : 'Intro'} · ${focus}`;
      $('#persona-summary').textContent = label;
      if(status){
        // Mostrar temporalmente el estado
        const statusEl = $('#chat-status') || $('#briefing-status');
        if (statusEl) {
          const originalText = statusEl.textContent;
          statusEl.textContent = status;
          setTimeout(()=> {
            if (statusEl.textContent === status) {
              statusEl.textContent = originalText;
            }
          }, 2400);
        }
      }
    }

    function appendUserMessage(content){
      const messagesContainer = $('#chat-messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message user';
      messageDiv.innerHTML = `<div class="content">${content}</div>`;
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function appendAssistantMessage(content){
      const messagesContainer = $('#chat-messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message assistant';
      messageDiv.innerHTML = `<div class="content">${content}</div>`;
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function showTypingIndicator(){
      const messagesContainer = $('#chat-messages');
      const typingDiv = document.createElement('div');
      typingDiv.className = 'message assistant';
      typingDiv.id = 'typing-indicator';
      typingDiv.innerHTML = `
        <div class="message-typing">
          <div class="typing-indicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
          <span>Escribiendo...</span>
        </div>
      `;
      messagesContainer.appendChild(typingDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function hideTypingIndicator(){
      const typingIndicator = $('#typing-indicator');
      if (typingIndicator) {
        typingIndicator.remove();
      }
    }

    function appendUser(content){
      state.conversation.push({ role:'user', content, createdAt:Date.now() });
      renderConversation();
    }

    function appendAssistant(content){
      state.conversation.push({ role:'assistant', content, createdAt:Date.now() });
      renderConversation();
    }

    function renderConversation(){
      const log = $('#chat-log');
      if (!log) return;
      
      log.innerHTML = '';
      const template = document.getElementById('message-template');
      state.conversation.forEach(msg=>{
        if(msg.role === 'system') return;
        const node = template.content.firstElementChild.cloneNode(true);
        node.classList.add(msg.role);
        node.querySelector('.content').textContent = msg.content;
        node.querySelector('.timestamp').textContent = new Date(msg.createdAt).toLocaleTimeString();
        log.appendChild(node);
      });
      log.scrollTop = log.scrollHeight;
    }

    async function sendToAgent(latestUserMessage){
      const button = $('#chat-send');
      button.disabled = true;
      const statusEl = $('#chat-status') || $('#briefing-status');
      if (statusEl) statusEl.textContent = 'Consultando agente…';
      
      try{
        // Recuperar contexto inicial de Wikipedia para grounding
        const wiki = await getWikipediaContext(latestUserMessage, state.prefs.lang || 'es');
        const messages = [
          { role:'system', content: composeSystemPrompt() },
          wiki ? { role:'system', content: wiki } : null,
          ...state.conversation.filter(m=>m.role!== 'system').map(({ role, content })=>({ role, content }))
        ].filter(Boolean);

        const provider = state.prefs.provider || 'deepseek';
        const model = state.prefs.model || (provider==='openai' ? 'chatgpt-5-nano' : 'deepseek-chat');
        const payload = { model, messages, temperature: Number(state.prefs?.temp ?? 0.2), max_tokens: 700 };
        let res;
        if(provider==='deepseek'){
          const cfg = state.config?.deepseek || {};
          if(cfg.proxyUrl){
            const headers = Object.assign({ 'Content-Type':'application/json' }, sanitizeHeaders(cfg.headers));
            res = await fetch(cfg.proxyUrl, { method:'POST', headers, body: JSON.stringify(payload) });
          }else if(cfg.apiKey && (location.hostname==='localhost' || location.hostname==='127.0.0.1' || location.protocol==='file:')){
            res = await fetch((cfg.apiBase||'https://api.deepseek.com') + '/chat/completions', {
              method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${cfg.apiKey}` }, body: JSON.stringify(payload)
            });
          }else{
            throw new Error('DeepSeek sin proxy. Configura deepseek.proxyUrl en vault.ink');
          }
        } else if(provider==='openai'){
          const cfg = state.config?.openai || {};
          if(cfg.proxyUrl){
            const headers = Object.assign({ 'Content-Type':'application/json' }, sanitizeHeaders(cfg.headers));
            res = await fetch(cfg.proxyUrl, { method:'POST', headers, body: JSON.stringify(payload) });
          }else if(cfg.apiKey && (location.hostname==='localhost' || location.hostname==='127.0.0.1' || location.protocol==='file:')){
            res = await fetch((cfg.apiBase||'https://api.openai.com/v1') + '/chat/completions', {
              method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${cfg.apiKey}` }, body: JSON.stringify(payload)
            });
          }else{
            throw new Error('OpenAI sin proxy. Configura openai.proxyUrl en vault.ink');
          }
        }
        if(!res.ok) throw new Error('El proxy respondió ' + res.status);
        const data = await res.json();
        const reply = data?.choices?.[0]?.message?.content?.trim() || 'No recibí contenido del modelo.';
        state.conversation.push({ role:'assistant', content: reply, createdAt:Date.now() });
        appendAssistantMessage(reply);
        if (statusEl) statusEl.textContent = 'Agente listo';
      }catch(err){
        appendAssistant('No se pudo contactar al agente: ' + err.message);
        if (statusEl) statusEl.textContent = 'Error de conexión';
      }finally{
        button.disabled = false;
      }
    }

    function composeSystemPrompt(){
      const base = state.systemPrompt || 'Eres un asistente de investigación de WikiScope.';
      const persona = `\n\nPerfil:\n- Nombre: ${state.prefs.username || 'Investigador/a'}\n- Idioma preferido: ${state.prefs.lang}\n- Nivel: ${state.prefs.level}\n- Formato: ${state.prefs.format}\n- Enfoques: ${(state.prefs.focus||[]).join(', ') || 'ninguno'}\n- Citas obligatorias: ${state.prefs.show_cites ? 'sí' : 'cuando sea relevante'}`;
      const mode = state.prefs?.mode === 'conversational' ? 'conversacional' : 'investigacion';
      const modeSpec = mode === 'conversacional'
        ? '\n\nModo: Conversacional.\n- Tono cercano, colaborativo y empático.\n- Prioriza brainstorming y creatividad.\n- No necesitas citar cada frase, pero evita inventar hechos. Cuando des datos concretos, sugiere cómo verificarlos (artículos/secciones).\n- Haz preguntas de clarificación y propone próximos pasos.'
        : '\n\nModo: Investigación.\n- Rigurosidad, concisión y citabilidad.\n- Prefiere bullets citados y separar hechos de hipótesis.\n- Si falta evidencia suficiente, dilo explícitamente y propone verificación.';
      const style = `\n\nPreferencias de estilo:\n- Tono: ${(state.prefs.tone||['neutro']).join(', ')}\n- Longitud: ${['muy corta','corta','media','larga','muy larga'][((state.prefs.length||3)-1)|0]}\n- Estructura: ${(state.prefs.structure||['bullets']).join(', ')}\n- Rigor de citas (0-1): ${(state.prefs.cite_level??0.7).toFixed(2)}\n- Instrucciones: ${state.prefs.notes||'N/A'}`;
      return base + persona + modeSpec + style + `\n\nParámetros: temperatura=${Number(state.prefs?.temp ?? 0.2).toFixed(2)}.` + '\nRespeta el idioma preferido del usuario.';
    }

    function sanitizeHeaders(headers){
      if(!headers) return {};
      const clean = {};
      for(const key in headers){
        const value = headers[key];
        if(typeof value === 'string' && value.includes('{{')) continue;
        clean[key] = value;
      }
      return clean;
    }

    async function runAnalysis(query){
      try{
        $('#analysis-card').style.display = 'block';
        $('#analysis-status').textContent = 'Analizando…';
        const lang = state.prefs.lang || 'es';
        const briefing = window.WikiAPI ? await window.WikiAPI.buildBriefing(query, { lang }) : null;
        if(!briefing){
          $('#analysis-content').textContent = 'No se encontró un artículo principal.';
          $('#analysis-status').textContent = '';
          return;
        }
        renderAnalysis(briefing);
        $('#analysis-status').textContent = 'Listo';
        // Alimentar al agente con este briefing como contexto adicional
        state.conversation.push({ role:'system', content: 'Briefing de Wikipedia: ' + JSON.stringify(briefing).slice(0,3000) });
      }catch(err){
        $('#analysis-content').textContent = 'Error al analizar: ' + err.message;
        $('#analysis-status').textContent = 'Error';
      }
    }

    function renderAnalysis(b){
      const el = $('#analysis-content');
      const mediaHtml = (b.media||[]).map(m=> `<img src="${m.thumb||m.url}" alt="${m.title}" style="height:64px;border-radius:8px;border:1px solid #e5e7eb">`).join(' ');
      const cats = (b.categories||[]).slice(0,8).map(c=> `<span class="pill">${c}</span>`).join(' ');
      const links = (b.links||[]).slice(0,8).map(l=> `<span class="pill">${l}</span>`).join(' ');
      const exts = (b.external||[]).slice(0,6).map(u=> `<a href="${u}" target="_blank" rel="noopener">${u.replace(/^https?:\/\//,'').slice(0,40)}…</a>`).join(' · ');
      el.innerHTML = `
        <div style="display:flex;gap:16px;align-items:flex-start">
          ${b.thumbnail?`<img src="${b.thumbnail}" alt="thumb" style="width:96px;height:96px;border-radius:12px;border:1px solid #e5e7eb;object-fit:cover">`:''}
          <div>
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
              <h3 style="margin:0">${b.title}</h3>
              <a href="${b.url}" target="_blank" rel="noopener" class="pill">Abrir en Wikipedia</a>
            </div>
            <p class="muted" style="margin:6px 0 8px">${b.description||''}</p>
            <p style="margin:0 0 8px">${(b.extract||'').slice(0,320)}${(b.extract||'').length>320?'…':''}</p>
          </div>
        </div>
        ${mediaHtml?`<div style="margin:10px 0 6px;display:flex;gap:8px;flex-wrap:wrap">${mediaHtml}</div>`:''}
        <div style="margin:6px 0 6px;display:flex;gap:8px;flex-wrap:wrap">${cats}</div>
        <div style="margin:6px 0 6px;display:flex;gap:8px;flex-wrap:wrap">${links}</div>
        <div class="muted" style="margin-top:6px">Vistas (30 días): promedio ${Math.round(b.pageviews?.avg||0)} / día</div>
        ${exts?`<div style="margin-top:10px">Fuentes externas: ${exts}</div>`:''}
      `;
    }

    async function getWikipediaContext(query, lang){
      try{
        // Usa el módulo WikiAPI si está presente; fallback al fetch sencillo
        let titles = [];
        if(window.WikiAPI){
          const sr = await window.WikiAPI.searchArticles(query.slice(0,160), { lang, limit: 2 });
          titles = sr.map(s=> s.title);
        }else{
          const q = encodeURIComponent(query.slice(0,160));
          const api = `https://${lang}.wikipedia.org/w/api.php?action=query&list=search&srsearch=${q}&format=json&origin=*`;
          const r = await fetch(api, { headers:{ 'Accept':'application/json' } });
          if(!r.ok) return '';
          const j = await r.json();
          titles = (j?.query?.search||[]).slice(0,2).map(it=>it.title);
        }
        const blocks = [];
        for(const t of titles){
          let d = null;
          if(window.WikiAPI){ d = await window.WikiAPI.pageSummary(t, { lang }); }
          else{
            const tt = encodeURIComponent(t.replace(/\s/g,'_'));
            const s = await fetch(`https://${lang}.wikipedia.org/api/rest_v1/page/summary/${tt}`);
            if(!s.ok) continue; d = await s.json();
          }
          const media = window.WikiAPI ? await window.WikiAPI.pageMedia(t, { lang, limit: 2 }) : [];
          const line = `- ${d.title}: ${d.description||''} — ${d.extract?.slice(0,400)||''} ${(media&&media.length)?'\n  Imagenes: '+media.map(m=>m.thumb||m.url).join(', '):''} (URL: ${d.content_urls?.desktop?.page||d.content_urls?.mobile?.page||''})`;
          blocks.push(line);
        }
        if(!blocks.length) return '';
        return 'Contexto de Wikipedia para grounding (no mostrar tal cual si es redundante):\n' + blocks.join('\n');
      }catch(_e){ return ''; }
    }

    function setMode(mode){
      state.prefs.mode = mode === 'conversational' ? 'conversational' : 'research';
      // Si cambia a conversacional y la temperatura es muy baja, súbela un poco; y viceversa
      if(state.prefs.mode === 'conversational' && (state.prefs.temp ?? 0.2) < 0.5){ state.prefs.temp = 0.8; }
      if(state.prefs.mode === 'research' && (state.prefs.temp ?? 0.2) > 0.6){ state.prefs.temp = 0.2; }
      updateModeUI();
      persistPrefs();
    }

    function updateModeUI(){
      const isConv = state.prefs?.mode === 'conversational';
      $('#mode-research').classList.toggle('active', !isConv);
      $('#mode-conv').classList.toggle('active', isConv);
      const tempEl = $('#temp'); const lbl = $('#temp-value');
      if(tempEl && lbl){ tempEl.value = Number(state.prefs?.temp ?? (isConv?0.8:0.2)).toFixed(2); lbl.textContent = Number(tempEl.value).toFixed(2); }
    }
  </script>
</body>
</html>

